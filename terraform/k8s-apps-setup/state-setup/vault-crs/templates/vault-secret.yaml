{{- range $ns := $.Values.secretNamespaces }}
apiVersion: redhatcop.redhat.io/v1alpha1
kind: VaultSecret
metadata:
  name: {{ $.Values.secretName }}
  namespace: {{ $ns }}
spec:
  refreshThreshold: 85 # after 85% of the lease_duration of the dynamic secret has elapsed, refresh the secret
  vaultSecretDefinitions:
{{- range $key, $value := $.Values.secretKeyMap }}
    - authentication:
        path: {{ $.Values.authPath }}
        role: {{ $.Values.authRole }}
        serviceAccount:
          name: {{ $.Values.authSvcAcct }}
      name: dynamicsecret_{{ $key | replace "-" "_" }}
      path: "{{ $.Values.vaultBasePath }}/{{ $.Values.resourceName }}/{{ $.Values.secretName }}-{{ $key }}"
{{- end }}
  output:
    name: {{ $.Values.secretName }}
    stringData:
{{- range $key, $value := $.Values.secretKeyMap }}
      {{ $key }}: '{{ $value }}'
{{- end }}
    type: Opaque
---
{{- end }}